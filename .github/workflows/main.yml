name: Build and Release Plugin

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-22.04
            arch: x86_64
            platform: ubuntu22.04-x86_64
          - os: ubuntu-24.04
            arch: x86_64
            platform: ubuntu24.04-x86_64
          - os: ubuntu-24.04-arm
            arch: aarch64
            platform: ubuntu24.04-aarch64

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            zip \
            unzip \
            wget \
            gperf \
            cmake \
            git \
            git-lfs \
            libc++-dev \
            libc++abi-dev \
            libexpat1-dev \
            lld \
            lldb \
            liblldb-dev \
            libomp5 \
            libomp-dev \
            llvm \
            llvm-dev \
            llvm-runtime \
            libllvm-ocaml-dev \
            clang \
            clangd \
            clang-format \
            clang-tidy \
            clang-tools \
            libclang-dev \
            libclang1 \
            python3-clang

      - name: Install LLVM 18
        run: |
          wget -O /tmp/llvm.sh https://apt.llvm.org/llvm.sh
          chmod +x /tmp/llvm.sh
          sudo bash /tmp/llvm.sh 18
          rm -f /tmp/llvm.sh

      - name: Configure clang alternatives
        run: |
          VERSION=18
          PRIORITY=100
          sudo update-alternatives --remove-all clang++ 2>/dev/null || true
          sudo update-alternatives --remove-all clang 2>/dev/null || true
          sudo update-alternatives --remove-all llvm-config 2>/dev/null || true
          if [[ -f /usr/bin/llvm-config-${VERSION} ]] && [[ -f /usr/bin/clang-${VERSION} ]]; then
            sudo update-alternatives \
              --install /usr/bin/llvm-config       llvm-config      /usr/bin/llvm-config-${VERSION} ${PRIORITY} \
              --slave   /usr/bin/llvm-ar           llvm-ar          /usr/bin/llvm-ar-${VERSION} \
              --slave   /usr/bin/llvm-as           llvm-as          /usr/bin/llvm-as-${VERSION} \
              --slave   /usr/bin/llvm-bcanalyzer   llvm-bcanalyzer  /usr/bin/llvm-bcanalyzer-${VERSION} \
              --slave   /usr/bin/llvm-cov          llvm-cov         /usr/bin/llvm-cov-${VERSION} \
              --slave   /usr/bin/llvm-diff         llvm-diff        /usr/bin/llvm-diff-${VERSION} \
              --slave   /usr/bin/llvm-dis          llvm-dis         /usr/bin/llvm-dis-${VERSION} \
              --slave   /usr/bin/llvm-dwarfdump    llvm-dwarfdump   /usr/bin/llvm-dwarfdump-${VERSION} \
              --slave   /usr/bin/llvm-extract      llvm-extract     /usr/bin/llvm-extract-${VERSION} \
              --slave   /usr/bin/llvm-link         llvm-link        /usr/bin/llvm-link-${VERSION} \
              --slave   /usr/bin/llvm-mc           llvm-mc          /usr/bin/llvm-mc-${VERSION} \
              --slave   /usr/bin/llvm-nm           llvm-nm          /usr/bin/llvm-nm-${VERSION} \
              --slave   /usr/bin/llvm-objdump      llvm-objdump     /usr/bin/llvm-objdump-${VERSION} \
              --slave   /usr/bin/llvm-ranlib       llvm-ranlib      /usr/bin/llvm-ranlib-${VERSION} \
              --slave   /usr/bin/llvm-readobj      llvm-readobj     /usr/bin/llvm-readobj-${VERSION} \
              --slave   /usr/bin/llvm-rtdyld       llvm-rtdyld      /usr/bin/llvm-rtdyld-${VERSION} \
              --slave   /usr/bin/llvm-size         llvm-size        /usr/bin/llvm-size-${VERSION} \
              --slave   /usr/bin/llvm-stress       llvm-stress      /usr/bin/llvm-stress-${VERSION} \
              --slave   /usr/bin/llvm-symbolizer   llvm-symbolizer  /usr/bin/llvm-symbolizer-${VERSION} \
              --slave   /usr/bin/llvm-tblgen       llvm-tblgen      /usr/bin/llvm-tblgen-${VERSION}
            sudo update-alternatives \
              --install /usr/bin/clang                 clang                 /usr/bin/clang-${VERSION} ${PRIORITY} \
              --slave   /usr/bin/clang++               clang++               /usr/bin/clang++-${VERSION}  \
              --slave   /usr/bin/asan_symbolize        asan_symbolize        /usr/bin/asan_symbolize-${VERSION} \
              --slave   /usr/bin/clang-cpp             clang-cpp             /usr/bin/clang-cpp-${VERSION} \
              --slave   /usr/bin/lldb                  lldb                  /usr/bin/lldb-${VERSION} \
              --slave   /usr/bin/lldb-server           lldb-server           /usr/bin/lldb-server-${VERSION}
          else
            echo "LLVM ${VERSION} not found, using system defaults."
          fi

      - name: Download external libraries
        env:
          PLATFORM: ${{ matrix.platform }}
        run: |
          set -euo pipefail
          mkdir -p external
          cd external
          URL="https://github.com/DanSmith888/BaseElements-Plugin-Libraries/releases/download/v0.1.0/external-${PLATFORM}.tar.gz"
          echo "Fetching external libraries from ${URL}"
          curl -sSL -o external.tar.gz "${URL}"
          tar -xzf external.tar.gz

      - name: Configure and build
        env:
          CC: clang
          CXX: clang++
        run: |
          mkdir -p build
          cd build
          cmake -DCMAKE_BUILD_TYPE=Release ..
          make -j"$(nproc)"

      - name: Collect build outputs
        run: |
          set -euo pipefail
          cp "build/BaseElements.fmx" "BaseElements-${{ matrix.platform }}.fmx"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: BaseElements-${{ matrix.platform }}
          path: BaseElements-${{ matrix.platform }}.fmx
          retention-days: 30

  build-arm-22:
    # Problem child: ubuntu22.04-aarch64, built in a controlled ARM container
    runs-on: ubuntu-22.04-arm
    container:
      image: ubuntu:22.04
    defaults:
      run:
        shell: bash
    env:
      PLATFORM: ubuntu22.04-aarch64

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install build dependencies inside container
        run: |
          apt-get update
          apt-get install -y \
            curl sudo lsb-release wget software-properties-common gnupg binutils \
            build-essential \
            zip \
            unzip \
            wget \
            gperf \
            cmake \
            git \
            git-lfs \
            libexpat1-dev \
            lld \
            lldb \
            liblldb-dev \
            libomp5 \
            libomp-dev \
            llvm \
            llvm-dev \
            llvm-runtime \
            clang \
            clangd \
            clang-format \
            clang-tidy \
            clang-tools \
            libclang-dev \
            libclang1 \
            python3-clang

          echo "=== libstdc++ symbols in container ==="
          strings /usr/lib/aarch64-linux-gnu/libstdc++.so.6 | grep GLIBCXX_ | sort -V | tail -10 || true

      - name: Download external libraries
        run: |
          set -euo pipefail
          mkdir -p external
          cd external
          URL="https://github.com/DanSmith888/BaseElements-Plugin-Libraries/releases/download/v0.1.0/external-${PLATFORM}.tar.gz"
          echo "Fetching external libraries from ${URL}"
          curl -sSL -o external.tar.gz "${URL}"
          tar -xzf external.tar.gz

      - name: Install LLVM 18
        run: |
          wget -O /tmp/llvm.sh https://apt.llvm.org/llvm.sh
          chmod +x /tmp/llvm.sh
          sudo bash /tmp/llvm.sh 18
          rm -f /tmp/llvm.sh

      - name: Configure clang alternatives
        run: |
          VERSION=18
          PRIORITY=100
          sudo update-alternatives --remove-all clang++ 2>/dev/null || true
          sudo update-alternatives --remove-all clang 2>/dev/null || true
          sudo update-alternatives --remove-all llvm-config 2>/dev/null || true
          if [[ -f /usr/bin/llvm-config-${VERSION} ]] && [[ -f /usr/bin/clang-${VERSION} ]]; then
            sudo update-alternatives \
              --install /usr/bin/llvm-config       llvm-config      /usr/bin/llvm-config-${VERSION} ${PRIORITY} \
              --slave   /usr/bin/llvm-ar           llvm-ar          /usr/bin/llvm-ar-${VERSION} \
              --slave   /usr/bin/llvm-as           llvm-as          /usr/bin/llvm-as-${VERSION} \
              --slave   /usr/bin/llvm-bcanalyzer   llvm-bcanalyzer  /usr/bin/llvm-bcanalyzer-${VERSION} \
              --slave   /usr/bin/llvm-cov          llvm-cov         /usr/bin/llvm-cov-${VERSION} \
              --slave   /usr/bin/llvm-diff         llvm-diff        /usr/bin/llvm-diff-${VERSION} \
              --slave   /usr/bin/llvm-dis          llvm-dis         /usr/bin/llvm-dis-${VERSION} \
              --slave   /usr/bin/llvm-dwarfdump    llvm-dwarfdump   /usr/bin/llvm-dwarfdump-${VERSION} \
              --slave   /usr/bin/llvm-extract      llvm-extract     /usr/bin/llvm-extract-${VERSION} \
              --slave   /usr/bin/llvm-link         llvm-link        /usr/bin/llvm-link-${VERSION} \
              --slave   /usr/bin/llvm-mc           llvm-mc          /usr/bin/llvm-mc-${VERSION} \
              --slave   /usr/bin/llvm-nm           llvm-nm          /usr/bin/llvm-nm-${VERSION} \
              --slave   /usr/bin/llvm-objdump      llvm-objdump     /usr/bin/llvm-objdump-${VERSION} \
              --slave   /usr/bin/llvm-ranlib       llvm-ranlib      /usr/bin/llvm-ranlib-${VERSION} \
              --slave   /usr/bin/llvm-readobj      llvm-readobj     /usr/bin/llvm-readobj-${VERSION} \
              --slave   /usr/bin/llvm-rtdyld       llvm-rtdyld      /usr/bin/llvm-rtdyld-${VERSION} \
              --slave   /usr/bin/llvm-size         llvm-size        /usr/bin/llvm-size-${VERSION} \
              --slave   /usr/bin/llvm-stress       llvm-stress      /usr/bin/llvm-stress-${VERSION} \
              --slave   /usr/bin/llvm-symbolizer   llvm-symbolizer  /usr/bin/llvm-symbolizer-${VERSION} \
              --slave   /usr/bin/llvm-tblgen       llvm-tblgen      /usr/bin/llvm-tblgen-${VERSION}
            sudo update-alternatives \
              --install /usr/bin/clang                 clang                 /usr/bin/clang-${VERSION} ${PRIORITY} \
              --slave   /usr/bin/clang++               clang++               /usr/bin/clang++-${VERSION}  \
              --slave   /usr/bin/asan_symbolize        asan_symbolize        /usr/bin/asan_symbolize-${VERSION} \
              --slave   /usr/bin/clang-cpp             clang-cpp             /usr/bin/clang-cpp-${VERSION} \
              --slave   /usr/bin/lldb                  lldb                  /usr/bin/lldb-${VERSION} \
              --slave   /usr/bin/lldb-server           lldb-server           /usr/bin/lldb-server-${VERSION}
          else
            echo "LLVM ${VERSION} not found, using system defaults."
          fi

      - name: Configure and build (ARM container)
        env:
          CC: clang
          CXX: clang++
        run: |
          mkdir -p build
          cd build
          cmake -DCMAKE_BUILD_TYPE=Release ..
          make -j"$(nproc)"

      - name: Check GLIBCXX usage in plugin
        run: |
          objdump -T build/BaseElements.fmx | grep GLIBCXX_ | sort -V | tail -10 || true

      - name: Collect build outputs
        run: |
          set -euo pipefail
          cp "build/BaseElements.fmx" "BaseElements-${PLATFORM}.fmx"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: BaseElements-${{ env.PLATFORM }}
          path: BaseElements-${{ env.PLATFORM }}.fmx
          retention-days: 30

  release:
    needs:
      - build
      - build-arm-22
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: artifacts/**/*
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
